<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#f4f7f9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ÈâÑÂ£ÅÂçòË™ûÂ∏≥</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;500;700;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --accent: #f59e0b;
            --success: #10b981;
            --error: #ef4444;
            --bg: #f8fafc;
            --text: #0f172a;
            --card-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.6);
            --shadow: 0 10px 40px -10px rgba(15, 23, 42, 0.15);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background: var(--bg);
            background-image:
                radial-gradient(at 10% 20%, rgba(99, 102, 241, 0.12) 0px, transparent 50%),
                radial-gradient(at 90% 80%, rgba(139, 92, 246, 0.12) 0px, transparent 50%);
            background-attachment: fixed;
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overscroll-behavior-y: none;
            user-select: none;
            -webkit-user-select: none;
        }

        .app-container {
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            width: 100%;
            height: 100vh;
            max-width: 600px;
            padding: 2.5rem 1.5rem;
            box-shadow: var(--shadow);
            text-align: center;
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        @media (min-width: 600px) {
            .app-container {
                height: auto;
                min-height: 85vh;
                border-radius: 32px;
                margin: 20px;
            }
        }

        h1 {
            color: var(--text);
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .btn-main,
        .btn-sub,
        .btn-answer,
        .btn-correct,
        .btn-wrong {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 20px;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }

        .btn-main {
            background: var(--primary);
            color: white;
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
            margin-bottom: 14px;
        }

        .btn-main:active {
            transform: scale(0.96);
        }

        .btn-sub {
            background: rgba(255, 255, 255, 0.8);
            color: var(--primary-dark);
            border: 1px solid rgba(79, 70, 229, 0.15);
            margin-bottom: 14px;
        }

        .btn-sub:active {
            background: rgba(79, 70, 229, 0.05);
            transform: scale(0.96);
        }

        .btn-answer {
            background: #1e293b;
            color: white;
            margin: 24px 0;
            box-shadow: 0 8px 20px rgba(30, 41, 59, 0.3);
        }

        .btn-answer:active {
            transform: scale(0.96);
        }

        .judgement-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 24px;
        }

        .btn-correct {
            background: var(--success);
            color: white;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-correct:active {
            transform: scale(0.96);
        }

        .btn-wrong {
            background: var(--error);
            color: white;
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
        }

        .btn-wrong:active {
            transform: scale(0.96);
        }

        .progress-info {
            background: rgba(255, 255, 255, 0.6);
            padding: 12px 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            font-size: 0.95rem;
            color: var(--primary-dark);
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .filter-section {
            background: rgba(255, 255, 255, 0.6);
            padding: 16px;
            border-radius: 20px;
            margin-bottom: 24px;
            text-align: left;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .filter-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #475569;
            margin-bottom: 10px;
        }

        .difficulty-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .diff-opt {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            background: white;
            color: #64748b;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .diff-opt.active {
            background: #e0e7ff;
            color: var(--primary);
            border-color: var(--primary);
        }

        /* List Area (Removed for performance) */

        /* Quiz UI */
        .q-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .q-meta {
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-end;
        }

        .q-progress {
            font-size: 0.95rem;
            color: #64748b;
            font-weight: 700;
        }

        .q-diff-badge {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 800;
            color: white;
        }

        .diff-1 {
            background: #3b82f6;
        }

        .diff-2 {
            background: #10b981;
        }

        .diff-3 {
            background: #f59e0b;
        }

        .diff-4 {
            background: #ef4444;
        }

        .q-source-badge {
            font-size: 0.7rem;
            background: #e2e8f0;
            color: #475569;
            padding: 2px 8px;
            border-radius: 8px;
            font-weight: 600;
        }

        .word-display {
            font-size: 2.6rem;
            font-weight: 900;
            margin: 1.5rem 0;
            color: #0f172a;
            min-height: 3.5rem;
            letter-spacing: -0.02em;
            line-height: 1.2;
        }

        .example-display {
            font-style: italic;
            color: #334155;
            font-size: 1.1rem;
            line-height: 1.6;
            padding: 18px;
            background: rgba(255, 255, 255, 0.7);
            border-left: 4px solid var(--primary);
            border-radius: 0 16px 16px 0;
            text-align: left;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
        }

        .feedback {
            display: none;
            background: rgba(248, 250, 252, 0.9);
            border: 1px solid rgba(226, 232, 240, 0.8);
            padding: 1.8rem;
            border-radius: 20px;
            text-align: left;
            margin-top: 1rem;
            animation: fadeIn 0.3s ease-out;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        }

        .feedback-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--primary);
            font-weight: 800;
            margin-top: 1.2rem;
            margin-bottom: 0.4rem;
            display: block;
        }

        .meaning-kobe {
            font-weight: 900;
            font-size: 1.6rem;
            color: var(--error);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .desc-box {
            font-size: 1rem;
            line-height: 1.6;
            background: white;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.03);
            margin-top: 5px;
            color: #475569;
        }

        .hidden {
            display: none !important;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Result UI */
        #score-text {
            font-size: 5.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 20px 0;
        }

        /* Edit Modal UI */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow-y: auto;
            text-align: left;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--text);
            margin: 0;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 700;
            color: #475569;
            margin-bottom: 6px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1rem;
            color: var(--text);
            background: #f8fafc;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .btn-edit {
            background: #f1f5f9;
            color: #475569;
            border: none;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 16px;
            transition: all 0.2s;
        }

        .btn-edit:hover {
            background: #e2e8f0;
            color: var(--primary);
        }

        .pos-tag {
            color: #0f172a;
            font-size: 0.75em;
            font-weight: 700;
            margin-right: 2px;
            vertical-align: baseline;
        }

        /* History List UI */
        .history-section {
            margin-top: 30px;
            text-align: left;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding-top: 20px;
        }

        .history-title {
            font-size: 1rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-list-container {
            max-height: 250px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:active {
            background: rgba(0, 0, 0, 0.05);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-word {
            font-weight: 700;
            color: var(--primary-dark);
        }

        .badge-focus {
            background: #fef08a;
            color: #ca8a04;
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: 800;
            white-space: nowrap;
        }

        .result-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 0.95rem;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-word {
            font-weight: 800;
            color: var(--primary-dark);
            flex: 1;
        }

        .result-icon {
            font-size: 1.2rem;
            margin-right: 12px;
            width: 24px;
            text-align: center;
        }

        .btn-focus {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #cbd5e1;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-focus.active {
            background: #fef08a;
            color: #ca8a04;
            border-color: #fde047;
            box-shadow: 0 2px 8px rgba(250, 204, 21, 0.2);
        }

        /* Additional Filter UI */
        .filter-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }

        .select-control {
            width: 100%;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            font-family: inherit;
            font-size: 0.9rem;
            color: #475569;
            background: white;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 700;
            color: #475569;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Start Screen -->
        <div id="start-screen">
            <h1>ÈâÑÂ£ÅÂçòË™ûÂ∏≥</h1>
            <p style="color: #64748b; margin-top: 0; margin-bottom: 20px; font-weight: 600;">Ëá™ÂàÜ„Å†„Åë„ÅÆÂº±ÁÇπÂÖãÊúç„Ç¢„Éó„É™</p>

            <div id="master-progress" class="progress-info">
                <span>üìö Ë™≠„ÅøËæº„Åø‰∏≠...</span>
            </div>

            <div class="filter-section">
                <div class="filter-title">Èõ£ÊòìÂ∫¶„ÅßÁµû„ÇäËæº„ÇÄ</div>
                <div class="difficulty-options">
                    <button class="diff-opt active" data-diff="all">ÂÖ®„Å¶</button>
                    <button class="diff-opt" data-diff="1">Lv.1</button>
                    <button class="diff-opt" data-diff="2">Lv.2</button>
                    <button class="diff-opt" data-diff="3">Lv.3</button>
                    <button class="diff-opt" data-diff="4">Lv.4</button>
                </div>

                <div class="filter-row">
                    <select id="section-filter" class="select-control">
                        <option value="all">„Åô„Åπ„Å¶„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥</option>
                    </select>

                    <label class="checkbox-label">
                        <input type="checkbox" id="focus-filter">
                        ÈáçÁÇπÂæ©ÁøíÂçòË™û„ÅÆ„ÅøÂá∫È°å
                    </label>
                </div>
            </div>

            <div style="margin-top: 1rem;">
                <button class="btn-main" onclick="startQuiz()">„ÉÜ„Çπ„Éà„ÇíÈñãÂßã (ÊúÄÂ§ß10Âïè)</button>
                <button class="btn-sub" onclick="openHistoryScreen()">üìñ Â≠¶ÁøíÂ±•Ê≠¥„ÇíË¶ã„Çã</button>
            </div>

            <!-- Â§âÊõ¥ÁÇπ: „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÉªÂæ©ÂÖÉÁî®„ÅÆ„Éá„Éº„ÇøÁÆ°ÁêÜ„Ç®„É™„Ç¢ -->
            <div
                style="margin-top: 30px; padding: 15px; background: rgba(255, 255, 255, 0.5); border-radius: 12px; border: 1px solid #e2e8f0;">
                <h3 style="font-size: 1rem; color: #475569; margin-bottom: 10px; text-align: center;">‚öôÔ∏è „Éá„Éº„ÇøÁÆ°ÁêÜ („Çª„Éº„Éñ„Éª„É≠„Éº„Éâ)
                </h3>
                <div style="display: flex; gap: 10px; flex-direction: column;">
                    <button class="btn-sub" onclick="exportData()" style="padding: 10px; font-size: 0.95rem;">üì•
                        „Éá„Éº„Çø„Çí„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó („Çª„Éº„Éñ)</button>
                    <input type="file" id="import-file" style="display: none;" accept=".json"
                        onchange="importData(event)">
                    <button class="btn-sub" onclick="document.getElementById('import-file').click()"
                        style="padding: 10px; font-size: 0.95rem;">üì§ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åã„ÇâÂæ©ÂÖÉ („É≠„Éº„Éâ)</button>
                </div>
            </div>

            <button
                style="border:none; background:none; color:#9ca3af; cursor:pointer; font-size:0.85rem; margin-top:30px; margin-bottom: 20px; text-decoration: underline;"
                onclick="resetProgress()">ÁøíÂæóË®òÈå≤„Çí„É™„Çª„ÉÉ„Éà</button>
        </div>

        <!-- History Screen UI -->
        <div id="history-ui" class="hidden">
            <h2 style="margin-bottom: 1rem; color: #1e293b;">üìñ Â≠¶ÁøíÂ±•Ê≠¥</h2>

            <div class="filter-row" style="margin-bottom: 1rem;">
                <select id="history-diff-filter" class="select-control" onchange="renderHistoryList()">
                    <option value="all">„Åô„Åπ„Å¶„ÅÆÈõ£ÊòìÂ∫¶</option>
                    <option value="1">Lv.1</option>
                    <option value="2">Lv.2</option>
                    <option value="3">Lv.3</option>
                    <option value="4">Lv.4</option>
                </select>
                <select id="history-section-filter" class="select-control" onchange="renderHistoryList()">
                    <option value="all">„Åô„Åπ„Å¶„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥</option>
                </select>
            </div>

            <div class="history-title" style="margin-top:0;">
                <span id="history-count">ÂÖ® 0 Ë™û</span>
                <span
                    style="font-size: 0.75rem; color: #64748b; font-weight: normal; margin-left:auto;">(„Çø„ÉÉ„Éó„Åó„Å¶Ëß£Ë™¨)</span>
            </div>

            <div id="history-list" class="history-list-container" style="max-height: 50vh;">
                <!-- History items will be populated here -->
            </div>

            <button class="btn-sub" onclick="closeHistoryScreen()" style="margin-top: 1rem;">Êàª„Çã</button>
        </div>

        <!-- Quiz UI -->
        <div id="quiz-ui" class="hidden">
            <div class="q-header">
                <div id="q-progress" class="q-progress">Card 1 / 10</div>
                <div class="q-meta">
                    <div id="q-diff-badge" class="q-diff-badge diff-1">Lv.1</div>
                    <div id="q-source-badge" class="q-source-badge">Sec 1 (P.10)</div>
                </div>
            </div>

            <div class="word-display" id="target-word">---</div>
            <div class="example-display" id="target-example">---</div>

            <button id="answer-btn" class="btn-answer" onclick="showFeedback()">Á≠î„Åà„ÇíÁ¢∫Ë™ç</button>

            <div id="feedback-ui" class="feedback">
                <div id="ans-show"></div>

                <div id="explanation-container">
                    <span class="feedback-label">Ëß£Ë™¨„ÉªË™ûÊ∫ê</span>
                    <div id="desc-show" class="desc-box"></div>
                </div>

                <span class="feedback-label">‰æãÊñáË®≥</span>
                <span id="trans-show" style="font-size:0.95rem; color:#475569; font-weight: 500;"></span>

                <button class="btn-edit" onclick="openEditModal()">üìù „Éá„Éº„Çø„ÇíÁ∑®ÈõÜ„Åô„Çã</button>

                <div class="judgement-grid">
                    <button class="btn-wrong" onclick="handleJudgement(false)">√ó Âøò„Çå„Åü</button>
                    <button class="btn-correct" onclick="handleJudgement(true)">‚óã Ë¶ö„Åà„ÅüÔºÅ</button>
                </div>
            </div>
        </div>

        <!-- Result UI -->
        <div id="result-ui" class="hidden">
            <h2 style="margin-bottom:0; color: #1e293b;">‰ªäÂõû„ÅÆ„Çπ„Ç≥„Ç¢</h2>
            <div id="score-text">0/10</div>
            <p id="score-message" style="color:#64748b; margin-bottom: 1.5rem; font-weight: 600;">„ÅäÁñ≤„ÇåÊßò„Åß„Åó„ÅüÔºÅ</p>

            <div id="result-list" class="result-list-container">
                <!-- Result items will be populated here -->
            </div>

            <button class="btn-main" onclick="startQuiz()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åô„Çã</button>
            <button class="btn-sub" onclick="location.reload()">„Éà„ÉÉ„Éó„Å´Êàª„Çã</button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ÂçòË™û„Éá„Éº„Çø„ÅÆÁ∑®ÈõÜ</h3>
                <button onclick="closeEditModal()"
                    style="background:none; border:none; font-size:1.5rem; color:#94a3b8; cursor:pointer;">&times;</button>
            </div>

            <div class="form-group">
                <label class="form-label">ÂçòË™û</label>
                <input type="text" id="edit-word" class="form-control" disabled
                    style="background:#e2e8f0; color:#64748b;">
            </div>
            <div class="form-group">
                <label class="form-label">ÊÑèÂë≥</label>
                <input type="text" id="edit-meaning" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Ëß£Ë™¨„ÉªË™ûÊ∫ê</label>
                <textarea id="edit-explanation" class="form-control"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">‰æãÊñáË®≥</label>
                <textarea id="edit-trans" class="form-control"></textarea>
            </div>

            <div style="display:flex; gap:12px; margin-top:10px;">
                <button class="btn-sub" onclick="closeEditModal()" style="margin:0; padding:12px;">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn-main" onclick="saveEditModal()" style="margin:0; padding:12px;">‰øùÂ≠ò„Åô„Çã</button>
            </div>
        </div>
    </div>

    <!-- Word Detail Modal -->
    <div id="detail-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="detail-word" style="font-size: 1.8rem; color: var(--primary-dark);"></h3>
                <button onclick="closeDetailModal()"
                    style="background:none; border:none; font-size:1.5rem; color:#94a3b8; cursor:pointer;">&times;</button>
            </div>

            <div class="feedback-label">ÊÑèÂë≥</div>
            <div id="detail-section"
                style="font-size: 0.95rem; color: #64748b; font-weight: bold; margin-bottom: 8px; display: none;"></div>
            <div id="detail-meaning" class="meaning-kobe" style="font-size: 1.4rem; margin-bottom: 16px;"></div>

            <div id="detail-exp-container" class="form-group hidden">
                <div class="feedback-label">Ëß£Ë™¨„ÉªË™ûÊ∫ê</div>
                <div id="detail-explanation" class="desc-box"></div>
            </div>

            <div class="form-group" style="margin-top: 16px;">
                <div class="feedback-label">‰æãÊñá</div>
                <div id="detail-example"
                    style="font-size: 1.05rem; font-style: italic; color: #334155; margin-bottom: 8px; line-height: 1.5;">
                </div>
                <div id="detail-trans" style="font-size:0.95rem; color:#475569; font-weight: 500;"></div>
            </div>

            <button class="btn-sub" onclick="closeDetailModal()" style="margin-top:20px; padding:14px;">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <!-- Â§âÊõ¥ÁÇπ: „Ç´„Çπ„Çø„É†„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÇÄ -->
    <script src="teppeki_words_data.js"></script>

    <script>
        let clearedWords = [];
        let currentQuizSet = [];
        let currentIdx = 0;
        let sessionScore = 0;
        let isListRendered = false;
        let selectedDifficulty = 'all';
        let customEdits = {}; // Store user edits: { word: { meaning, explanation, example_trans } }
        let focusWords = [];
        let sessionResults = [];

        // Difficulty Selector Logic
        document.querySelectorAll('.diff-opt').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.diff-opt').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                selectedDifficulty = e.target.getAttribute('data-diff');
            });
        });

        // Safe LocalStorage Access
        try {
            const savedProgress = localStorage.getItem('teppeki_custom_v1');
            if (savedProgress) clearedWords = JSON.parse(savedProgress);

            const savedEdits = localStorage.getItem('teppeki_custom_edits_v1');
            if (savedEdits) customEdits = JSON.parse(savedEdits);

            const savedFocus = localStorage.getItem('teppeki_custom_focus_v1');
            if (savedFocus) focusWords = JSON.parse(savedFocus);
        } catch (e) {
            console.warn('LocalStorage error:', e);
        }

        function formatPosTags(text) {
            if (!text) return text;
            return text.replace(/(^|[\s„ÄÄ])(Âêç|‰ªñ|Ëá™|ÂΩ¢|ÂâØ|Âè•|Ââç|Êé•|Ëá™‰ªñ|ÂâçÊé•)(?=[„Äú\s„ÄÄ‚ë†-‚ë≥\(\Ôºà]|$)/g, '$1<span class="pos-tag">$2</span>');
        }

        const sectionNameMap = {
            "SECTION1": "ÈáçË¶Å„Å™„Éª„Åï„Åï„ÅÑ„Å™",
            "SECTION2": "ÁâπÂæ¥„ÉªÊòéÁ¢∫„Åï„ÉªÁÇπ",
            "SECTION3": "ÊßãÈÄ†„ÉªÊßãÊàê",
            "SECTION4": "ÂãïË©û„Çí„Ç§„É°„Éº„Ç∏„Åô„Çã„ÉªÔºë",
            "SECTION5": "Âà∂Á¥Ñ„ÉªÂº∑Âà∂„ÉªÁ¶ÅÊ≠¢",
            "SECTION6": "ÈòªÂÆ≥„ÉªÈô§Âéª„Éª‰æõÁµ¶„Éª‰øÉÈÄ≤",
            "SECTION7": "ÁõÆÁöÑ„ÉªÂÆüË°å„ÉªÈÅîÊàê",
            "SECTION8": "ÊôÇÈñì",
            "SECTION9": "Èáë„ÉªÁµåÊ∏à",
            "SECTION10": "Â†¥ÊâÄ„ÉªÈ†òÂüü„ÉªÁØÑÂõ≤",
            "SECTION11": "Áô∫Áîü„ÉªÁπÅÊ†Ñ„ÉªË°∞ÈÄÄ„ÉªÊ∂àÊªÖ",
            "SECTION12": "Â§öÁæ©Ë™û„ÉªÔºë",
            "SECTION13": "Âü∫Êú¨ÂçòË™û„ÅÆÁ¢∫Ë™ç",
            "SECTION14": "Èñ¢‰øÇ„ÉªÂØæÁ´ã„Éª‰∏ÄËá¥",
            "SECTION15": "Ë®ÄË™û„ÉªÊñáÂ≠¶",
            "SECTION16": "Ë™øÊüª„ÉªÁ†îÁ©∂",
            "SECTION17": "Ë≠∞Ë´ñ„Éª‰∏ªÂºµ„ÉªË¶ÅÊ±Ç",
            "SECTION18": "Ë™ûÊ∫ê„Åã„ÇâË¶ö„Åà„Çã",
            "SECTION19": "ÂäõÈñ¢‰øÇ",
            "SECTION20": "Áü•Ë¶ö„ÉªÊÑüË¶ö„ÉªÊÑüÊÉÖ",
            "SECTION21": "ÂñÑÊÇ™„ÉªÁäØÁΩ™",
            "SECTION22": "Êï∞„ÉªÈáè",
            "SECTION23": "ÊÄùËÄÉ„ÉªË™çË≠ò„ÉªÁü•",
            "SECTION24": "‰∫∫„Éª‰∫∫Áîü",
            "SECTION25": "‰∫∫ÈñìÈñ¢‰øÇ",
            "SECTION26": "‰æ°ÂÄ§„ÉªÂü∫Ê∫ñ„ÉªÈÅ∏Êäû„ÉªÂá∫Êù•‰∫ã„ÉªÂèÇÂä†",
            "SECTION27": "ÊîøÊ≤ª",
            "SECTION28": "Áî£Ê•≠",
            "SECTION29": "ÂåªÂ≠¶„ÉªÂåñÂ≠¶",
            "SECTION30": "ÂÆóÊïô„ÉªÊ∞ëÊóè„ÉªÊÖ£Áøí",
            "SECTION31": "Ëá™ÁÑ∂„ÉªÁí∞Â¢É",
            "SECTION32": "Áü≠„ÅÑÂçòË™û",
            "SECTION33": "ÂÇæÂêë„ÉªÂèØËÉΩÊÄß„ÉªÂèçÂøú",
            "SECTION34": "Ë°£È£ü‰Ωè„ÉªÊó•Â∏∏",
            "SECTION35": "Á®ãÂ∫¶„ÉªÂâ≤Âêà",
            "SECTION36": "ÂãïË©û„Çí„Ç§„É°„Éº„Ç∏„Åô„Çã„ÉªÔºí",
            "SECTION37": "Âü∫Êú¨ÂãïË©û„ÇíÁî®„ÅÑ„ÅüÁÜüË™ûË°®Áèæ„ÉªÔºë",
            "SECTION38": "ÁÜüË™ûË°®Áèæ„ÉªÔºí",
            "SECTION39": "ÁÜüË™ûË°®Áèæ„ÉªÔºì",
            "SECTION40": "ÂøÉ„ÉªË∫´‰Ωì",
            "SECTION41": "„Ç≥„É≠„Ç±„Éº„Ç∑„Éß„É≥„ÅßË¶ö„Åà„ÇãÂΩ¢ÂÆπË©û",
            "SECTION42": "„Ç´„Çø„Ç´„ÉäËã±Ë™û",
            "SECTION43": "ÊïôËÇ≤„Éª„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº",
            "SECTION44": "Â§öÁæ©Ë™û„ÉªÔºí",
            "SECTION45": "Ê≠¥Âè≤„ÉªËªç‰∫ã",
            "SECTION46": "Êé•Á∂öË©û„ÉªÂâØË©û„ÉªÂâçÁΩÆË©û",
            "SECTION47": "Èõ£ÂçòË™û„ÉªÔºë",
            "SECTION48": "Èõ£ÂçòË™û„ÉªÔºí",
            "SECTION49": "Èõ£ÂçòË™û„ÉªÔºì",
            "SECTION50": "Èõ£ÂçòË™û„ÉªÔºî"
        };

        function getSectionDisplayName(secString) {
            if (!secString) return "";
            const key = secString.replace(" #", "");
            if (sectionNameMap[key]) {
                return `${secString}: ${sectionNameMap[key]}`;
            }
            return secString;
        }

        function populateSectionFilter() {
            if (typeof myWordData === 'undefined') return;
            const selectEl = document.getElementById('section-filter');
            const historySelectEl = document.getElementById('history-section-filter');
            const sections = new Set();
            myWordData.forEach(item => {
                if (item.section) sections.add(item.section);
            });

            Array.from(sections).sort((a, b) => {
                const numA = parseInt(a.replace(/[^0-9]/g, ''), 10) || 0;
                const numB = parseInt(b.replace(/[^0-9]/g, ''), 10) || 0;
                return numA - numB;
            }).forEach(sec => {
                const displayName = getSectionDisplayName(sec);

                const opt = document.createElement('option');
                opt.value = sec;
                opt.innerText = displayName;
                selectEl.appendChild(opt);

                const optHist = document.createElement('option');
                optHist.value = sec;
                optHist.innerText = displayName;
                historySelectEl.appendChild(optHist);
            });
        }

        window.onload = () => {
            try {
                if (typeof myWordData !== 'undefined') {
                    // Apply saved edits to myWordData in memory
                    myWordData.forEach(item => {
                        if (customEdits[item.word]) {
                            Object.assign(item, customEdits[item.word]);
                        }
                    });
                    populateSectionFilter();
                    updateUI();
                } else {
                    document.getElementById('master-progress').innerHTML = "<span style='color:red;'>‚ö†Ô∏è „Éá„Éº„Çø(custom_data.js)„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</span>";
                }
            } catch (e) {
                document.getElementById('master-progress').innerHTML = "<span style='color:red;'>‚ö†Ô∏è ÂàùÊúüÂåñ„Ç®„É©„Éº: " + e.message + "</span>";
            }
        };

        function updateUI() {
            document.getElementById('master-progress').innerHTML = `<span>üéØ ÁøíÂæóÊ∏à„Åø: <b>${clearedWords.length}</b> / ${myWordData.length} Ë™û</span>`;
        }

        function openHistoryScreen() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('history-ui').classList.remove('hidden');
            renderHistoryList();
        }

        function closeHistoryScreen() {
            document.getElementById('history-ui').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
        }

        function renderHistoryList() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';

            // Collect base history items
            let history = myWordData.filter(i => clearedWords.includes(i.word) || focusWords.includes(i.word));

            // Apply History Filters
            const diffFilter = document.getElementById('history-diff-filter').value;
            if (diffFilter !== 'all') {
                history = history.filter(i => i.difficulty == diffFilter);
            }

            const secFilter = document.getElementById('history-section-filter').value;
            if (secFilter !== 'all') {
                history = history.filter(i => i.section === secFilter);
            }

            document.getElementById('history-count').innerText = `ÂÖ® ${history.length} Ë™û`;

            if (history.length === 0) {
                container.innerHTML = '<div class="history-empty">Ë©≤ÂΩì„Åô„ÇãÂ≠¶ÁøíÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</div>';
                return;
            }

            // Display latest first
            [...history].reverse().forEach(item => {
                const el = document.createElement('div');
                el.className = 'history-item';
                el.onclick = () => showWordDetail(item.word);

                const isFocus = focusWords.includes(item.word);
                const badgeHtml = isFocus ? '<span class="badge-focus">‚òÖ ÈáçÁÇπ</span>' : '';

                el.innerHTML = `
                    <div class="history-word">${item.word}</div>
                    ${badgeHtml}
                `;
                container.appendChild(el);
            });
        }

        function showWordDetail(wordStr) {
            const item = myWordData.find(i => i.word === wordStr);
            if (!item) return;

            document.getElementById('detail-word').innerText = item.word;

            const sectionEl = document.getElementById('detail-section');
            if (item.section) {
                sectionEl.innerText = getSectionDisplayName(item.section);
                sectionEl.style.display = 'block';
            } else {
                sectionEl.style.display = 'none';
            }

            document.getElementById('detail-meaning').innerHTML = formatPosTags(item.meaning);

            const expContainer = document.getElementById('detail-exp-container');
            if (item.explanation && item.explanation.trim() !== '') {
                expContainer.classList.remove('hidden');
                document.getElementById('detail-explanation').innerHTML = formatPosTags(item.explanation);
            } else {
                expContainer.classList.add('hidden');
            }

            document.getElementById('detail-example').innerText = item.example || "No example provided.";
            document.getElementById('detail-trans').innerText = item.example_trans || "Ë®≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ";

            document.getElementById('detail-overlay').classList.add('active');
        }

        function closeDetailModal() {
            document.getElementById('detail-overlay').classList.remove('active');
        }

        // Word list functions removed natively to avoid performance issues

        function resetProgress() {
            if (confirm("ÁøíÂæóË®òÈå≤„Çí„Åô„Åπ„Å¶Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºüÔºà‚Äª‰∫ãÂâç„Å´„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÂèñ„Çã„Åì„Å®„ÇíÊé®Â•®„Åó„Åæ„ÅôÔºâ")) {
                localStorage.removeItem('teppeki_custom_v1');
                localStorage.removeItem('teppeki_custom_focus_v1');
                location.reload();
            }
        }

        // --- Â§âÊõ¥ÁÇπ: „Éá„Éº„Çø„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó („Çª„Éº„Éñ) Ê©üËÉΩ ---
        function exportData() {
            const dataToSave = {
                clearedWords: clearedWords,
                focusWords: focusWords,
                customEdits: customEdits,
                timestamp: new Date().toISOString()
            };

            const dataStr = JSON.stringify(dataToSave, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            const dateStr = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            a.download = `teppeki_backup_${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- Â§âÊõ¥ÁÇπ: „Éá„Éº„ÇøÂæ©ÂÖÉ („É≠„Éº„Éâ) Ê©üËÉΩ ---
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (importedData.clearedWords !== undefined) {
                        localStorage.setItem('teppeki_custom_v1', JSON.stringify(importedData.clearedWords));
                    }
                    if (importedData.focusWords !== undefined) {
                        localStorage.setItem('teppeki_custom_focus_v1', JSON.stringify(importedData.focusWords));
                    }
                    if (importedData.customEdits !== undefined) {
                        localStorage.setItem('teppeki_custom_edits', JSON.stringify(importedData.customEdits));
                    }

                    alert("„Éá„Éº„Çø„ÅÆÂæ©ÂÖÉ„Å´ÊàêÂäü„Åó„Åæ„Åó„ÅüÔºÅ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Åæ„Åô„ÄÇ");
                    location.reload();

                } catch (err) {
                    alert("„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊ≠£„Åó„ÅÑ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´Ôºà.jsonÔºâ„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                    console.error("Import error:", err);
                }
            };
            reader.readAsText(file);

            // ÂÖ•Âäõ„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶Âêå„Åò„Éï„Ç°„Ç§„É´„ÇíÂÜçÂ∫¶ÈÅ∏„Åπ„Çã„Çà„ÅÜ„Å´„Åô„Çã
            event.target.value = '';
        }

        function startQuiz() {
            // Unlock Audio Context for iOS
            if (window.speechSynthesis) {
                const uttr = new SpeechSynthesisUtterance('');
                window.speechSynthesis.speak(uttr);
            }

            // Filter data
            let source = myWordData;

            // Apply Cumulative Filters

            // 1. Difficulty filter
            if (selectedDifficulty !== 'all') {
                source = source.filter(i => i.difficulty == selectedDifficulty);
            }

            // 2. Section filter
            const selectedSection = document.getElementById('section-filter').value;
            if (selectedSection !== 'all') {
                source = source.filter(i => i.section === selectedSection);
            }

            // 3. Focus Review Words filter
            const isFocusOnly = document.getElementById('focus-filter').checked;
            if (isFocusOnly) {
                source = source.filter(i => focusWords.includes(i.word));
            }

            if (source.length === 0) {
                alert("Ë©≤ÂΩì„Åô„ÇãÊù°‰ª∂„ÅÆÂçòË™û„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
                return;
            }

            // Unlearned filter: Only apply if we are NOT in focus-only mode
            let unlearned = source;
            if (!isFocusOnly) {
                unlearned = source.filter(i => !clearedWords.includes(i.word));
            }

            if (unlearned.length === 0) {
                if (!confirm("ÊåáÂÆö„Åï„Çå„ÅüÊù°‰ª∂„ÅÆÂçòË™û„ÅØ„Åô„Åπ„Å¶„Éû„Çπ„Çø„ÉºÊ∏à„Åø„Åß„ÅôÔºÅÂæ©Áøí„ÉÜ„Çπ„Éà„ÇíË°å„ÅÑ„Åæ„Åô„ÅãÔºü")) {
                    return;
                }
                unlearned = source;
            }

            // Randomize and slice
            currentQuizSet = unlearned.sort(() => Math.random() - 0.5).slice(0, 10);
            currentIdx = 0; sessionScore = 0; sessionResults = [];

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('result-ui').classList.add('hidden');
            document.getElementById('quiz-ui').classList.remove('hidden');

            renderQuestion();
        }

        function renderQuestion() {
            const i = currentQuizSet[currentIdx];
            document.getElementById('q-progress').innerText = `Card ${currentIdx + 1} / ${currentQuizSet.length}`;

            // Set Badges
            const diffBadge = document.getElementById('q-diff-badge');
            diffBadge.innerText = `Lv.${i.difficulty}`;
            diffBadge.className = `q-diff-badge diff-${i.difficulty}`;

            const sourceBadge = document.getElementById('q-source-badge');
            sourceBadge.innerText = `${getSectionDisplayName(i.section)} (P.${i.page})`;

            const wordEl = document.getElementById('target-word');
            wordEl.innerText = i.word;

            // Animation reset
            wordEl.style.animation = 'none';
            wordEl.offsetHeight;
            wordEl.style.animation = 'fadeIn 0.5s';

            document.getElementById('target-example').innerText = i.example || "No example provided.";
            document.getElementById('answer-btn').classList.remove('hidden');
            document.getElementById('feedback-ui').style.display = 'none';

            speak(i.word);
        }

        function showFeedback() {
            const i = currentQuizSet[currentIdx];
            document.getElementById('answer-btn').classList.add('hidden');
            document.getElementById('feedback-ui').style.display = 'block';

            // Meaning
            document.getElementById('ans-show').innerHTML = `<div class="meaning-kobe">${formatPosTags(i.meaning)}</div>`;

            // Explanation
            if (i.explanation && i.explanation.trim() !== '') {
                document.getElementById('explanation-container').classList.remove('hidden');
                document.getElementById('desc-show').innerHTML = formatPosTags(i.explanation);
            } else {
                document.getElementById('explanation-container').classList.add('hidden');
            }

            // Translation
            document.getElementById('trans-show').innerText = i.example_trans || "Ë®≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ";

            speak(i.example);
        }

        function speak(text) {
            if (!window.speechSynthesis || !text) return;
            window.speechSynthesis.cancel();
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'en-US';
            uttr.rate = 1.0;

            const voices = window.speechSynthesis.getVoices();
            const enVoice = voices.find(v => v.lang === 'en-US' && v.name.includes('Samantha'))
                || voices.find(v => v.lang === 'en-US')
                || voices.find(v => v.lang.startsWith('en'));

            if (enVoice) uttr.voice = enVoice;
            window.speechSynthesis.speak(uttr);
        }

        function handleJudgement(isCorrect) {
            const word = currentQuizSet[currentIdx].word;
            sessionResults.push({ word: word, isCorrect: isCorrect });

            if (isCorrect) {
                sessionScore++;
                if (!clearedWords.includes(word)) clearedWords.push(word);
                localStorage.setItem('teppeki_custom_v1', JSON.stringify(clearedWords));
            }
            currentIdx++;
            if (currentIdx < currentQuizSet.length) {
                renderQuestion();
            } else {
                document.getElementById('quiz-ui').classList.add('hidden');
                document.getElementById('result-ui').classList.remove('hidden');
                document.getElementById('score-text').innerText = `${sessionScore}/${currentQuizSet.length}`;
                renderResultList();
            }
        }

        function renderResultList() {
            const container = document.getElementById('result-list');
            container.innerHTML = ''; // clear

            sessionResults.forEach(item => {
                const el = document.createElement('div');
                el.className = 'result-item';

                const icon = item.isCorrect ? '<span class="result-icon" style="color:var(--success)">‚≠ï</span>' : '<span class="result-icon" style="color:var(--error)">‚ùå</span>';

                const isFocus = focusWords.includes(item.word);
                const btnClass = isFocus ? 'btn-focus active' : 'btn-focus';
                const btnText = isFocus ? '‚òÖ ÈáçÁÇπÂæ©ÁøíÂçòË™û' : '‚òÜ ÈáçÁÇπÂæ©ÁøíÂçòË™û';

                el.innerHTML = `
                    ${icon}
                    <div class="result-word">${item.word}</div>
                    <button class="${btnClass}" onclick="toggleFocusWord('${item.word.replace(/'/g, "\\'")}', this)">${btnText}</button>
                `;
                container.appendChild(el);
            });
        }

        function toggleFocusWord(word, btnEl) {
            const idx = focusWords.indexOf(word);
            if (idx > -1) {
                focusWords.splice(idx, 1);
                btnEl.className = 'btn-focus';
                btnEl.innerText = '‚òÜ ÈáçÁÇπÂæ©ÁøíÂçòË™û';
            } else {
                focusWords.push(word);
                btnEl.className = 'btn-focus active';
                btnEl.innerText = '‚òÖ ÈáçÁÇπÂæ©ÁøíÂçòË™û';
            }
            try {
                localStorage.setItem('teppeki_custom_focus_v1', JSON.stringify(focusWords));
            } catch (e) { console.warn(e); }
        }

        // Edit Modal Logic
        function openEditModal() {
            const i = currentQuizSet[currentIdx];
            document.getElementById('edit-word').value = i.word;
            document.getElementById('edit-meaning').value = i.meaning || '';
            document.getElementById('edit-explanation').value = i.explanation || '';
            document.getElementById('edit-trans').value = i.example_trans || '';

            document.getElementById('edit-overlay').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-overlay').classList.remove('active');
        }

        function saveEditModal() {
            const word = document.getElementById('edit-word').value;
            const newMeaning = document.getElementById('edit-meaning').value;
            const newExplanation = document.getElementById('edit-explanation').value;
            const newTrans = document.getElementById('edit-trans').value;

            // Update customEdits and memory
            customEdits[word] = {
                meaning: newMeaning,
                explanation: newExplanation,
                example_trans: newTrans
            };

            const i = currentQuizSet[currentIdx];
            i.meaning = newMeaning;
            i.explanation = newExplanation;
            i.example_trans = newTrans;

            // Re-render feedback UI instantly
            showFeedback();

            // Save to localStorage
            try {
                localStorage.setItem('teppeki_custom_edits_v1', JSON.stringify(customEdits));
            } catch (e) { console.warn('Edit save error', e); }

            closeEditModal();
        }

        // Export Data Logic
        async function exportData() {
            if (typeof myWordData === 'undefined') return;

            // Format data back to JS string
            const jsContent = `const myWordData = ${JSON.stringify(myWordData, null, 4)};`;

            // Try standard File System Access API
            try {
                if (window.showSaveFilePicker) {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: 'custom_data.js',
                        types: [{
                            description: 'JavaScript File',
                            accept: { 'application/javascript': ['.js'] },
                        }],
                    });
                    const writable = await handle.createWritable();
                    await writable.write(jsContent);
                    await writable.close();
                    alert("‚úÖ „Éá„Éº„Çø„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ");
                    return;
                }
            } catch (e) {
                if (e.name !== 'AbortError') console.warn(e);
            }

            // Fallback: Download via <a> tag
            const blob = new Blob([jsContent], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'custom_data.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("üì¶ „Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü„ÄÇÂÖÉ„ÅÆ„Éï„Ç©„É´„ÉÄ„ÅÆ custom_data.js „Çí‰∏äÊõ∏„Åç„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ");
        }
    </script>
</body>

</html>